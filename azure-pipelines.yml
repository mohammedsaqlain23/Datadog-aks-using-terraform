trigger:
  - main

pool:
  vmImage: ubuntu-latest

# üîê Variable Group from Library
variables:
  - group: datadog-aks-vars

steps:
  - checkout: self

  # Install Terraform
  - task: TerraformInstaller@1
    displayName: Install Terraform
    inputs:
      terraformVersion: '1.6.6'

  # Terraform Init
  - task: TerraformTaskV4@4
    displayName: Terraform Init
    inputs:
      provider: azurerm
      command: init
      environmentServiceNameAzureRM: azure-connection

  # Terraform Plan
  - task: TerraformTaskV4@4
    displayName: Terraform Plan
    inputs:
      provider: azurerm
      command: plan
      environmentServiceNameAzureRM: azure-connection
    env:
      TF_VAR_aks_name: $(AKS_CLUSTER_NAME)
      TF_VAR_resource_group: $(AKS_RESOURCE_GROUP)
      TF_VAR_datadog_api_key: $(DATADOG_API_KEY)

  # Terraform Apply
  - task: TerraformTaskV4@4
    displayName: Terraform Apply
    inputs:
      provider: azurerm
      command: apply
      environmentServiceNameAzureRM: azure-connection
      args: "-auto-approve"
    env:
      TF_VAR_aks_name: $(AKS_CLUSTER_NAME)
      TF_VAR_resource_group: $(AKS_RESOURCE_GROUP)
      TF_VAR_datadog_api_key: $(DATADOG_API_KEY)

